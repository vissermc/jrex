function jRex(a,b){var c=a instanceof RegExp?new RegExp(a,b):new RegExp((new RegexBuilder).construct(a),b||("function"==typeof a.flags?a.flags():a.flags));return new jRexObj(c)}var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},jRexNode=function(){function a(a,b){this._parent=a,this._iter=b}return a.prototype.getIter=function(){return this._iter},a.prototype.map=function(b){var c=this.getIter();return new a(this,function(a,d){return c(a,function(a,c){return d(b(a),c)})})},a.prototype.captures=function(){return this.map(function(a){return a.captures()})},a.prototype.text=function(a){return this.map(function(b){return b.text(a)})},a.prototype.index=function(){return this.map(function(a){return a.index()})},a.prototype.reduce=function(b,c){var d=null==c?null:"function"==typeof c?c:"object"==typeof c?function(a){return function(){return JSON.parse(a)}}(JSON.stringify(c)):function(){return c},e=this.getIter();return new a(this,null==d?function(a,c){var d,f;return e(a,function(a,c){return void(d=f?b(d,a):(f=!0,a))}),c(d),!0}:function(a,c){var f=d();return e(a,function(a,c){return void(f=b(f,a))}),c(f),!0})},a.prototype.filter=function(b){var c=this.getIter();return new a(this,function(a,d){return c(a,function(a,c){return b(a)?d(a,c):void 0})})},a.prototype["while"]=function(b){var c=this.getIter();return new a(this,function(a,d){return c(a,function(a,c){return b(a)?d(a,c):null})})},a.prototype.henceforth=function(b){var c=this.getIter();return new a(this,function(a,d){var e;return c(a,function(a,c){return e||(e=b(a))?d(a,c):void 0})})},a.prototype.collect=function(b){var c=this.getIter();return new a(this,function(a,d){var e=b;return c(a,function(a,b){return--e>=0?d(a,b):null})})},a.prototype.skip=function(b){var c=this.getIter();return new a(this,function(a,d){var e=b;return c(a,function(a,b){return 0>e||--e<0?d(a,b):void 0})})},a.prototype.first=function(){var b=this.getIter();return new a(this,function(a,c){return b(a,function(a,b){return c(a,b),!0})})},a.prototype.last=function(){var b=this.getIter();return new a(this,function(a,c){var d,e,f=!1;return b(a,function(a,b){d=a,e=b,f=!0}),f&&c(d,e),!0})},a.prototype.format=function(a){var b=function(b){return jRex(/\$\$|\$&|\$([0-9]+)/).map(function(a){switch(a.text()){case"$$":return"$";case"$&":return b.text();default:return b.text(parseInt(a.text(1)))}}).replace(a)};return this.map(b)},a.prototype.eval=function(a,b){var c=[],d=this.getIter()({text:a,startPos:b},function(a){c.push(a)});return d?c[0]:c},a.prototype.test=function(a,b){return this.getIter()({text:a,startPos:b},function(a){return!0})||!1},a.prototype.replace=function(a,b){var c="",d=0;return this.getIter()({text:a,startPos:b},function(b,e){c+=a.substring(d,e.index())+b,d=e.endIndex()}),c+a.substr(d)},a.prototype.split=function(a,b){var c=[],d=null;return this.getIter()({text:a,startPos:b},function(b,e){c.push(a.substring(d||0,e.index())),d=e.endIndex()}),null!=d&&c.push(a.substring(d)),c},a}(),jRexResult=function(){function a(a,b,c){this._regex=a,this._result=b,this._endOfPrevIndex=c}return a.prototype.after=function(){return this.input().substring(this.endIndex())},a.prototype.between=function(){return this.input().substring(this._endOfPrevIndex,this.index())},a.prototype.before=function(){return this.input().substring(0,this.index())},a.prototype.endIndex=function(){return this.index()+this.text().length},a.prototype.index=function(){return this._result.index},a.prototype.input=function(){return this._result.input},a.prototype.text=function(a){return this._result[a?a:0]},a.prototype.setNextSearch=function(a){this._regex.lastIndex=a},a.prototype.captures=function(){return this._result.slice(1)},a.prototype.toJSON=function(){return{index:this.index(),texts:this._result}},a}(),jRexObj=function(a){function b(b){a.call(this),this._regex=b,this._flagsGlobal="g"+this.flags().replace("g","")}return __extends(b,a),b.prototype.getIter=function(){var a=this;return function(b,c){return a.iter(b.text,c,b.startPos)}},b.prototype.iter=function(a,b,c){var d,e=0,f=new RegExp(this._regex.source,this._flagsGlobal);for(f.lastIndex=c||0;null!==(d=f.exec(a));){var g=new jRexResult(f,d,e);e=f.lastIndex;var h=b.call(this,g,g);if("undefined"!=typeof h)return h}},b.prototype.flags=function(){return(this._regex+"").replace(/.+\//,"")},b.prototype.regex=function(){return new RegExp(this._regex.source,this.flags())},b.prototype.toJSON=function(){return{regex:this._regex.source,flags:this.flags()}},b}(jRexNode),RegexBuilder=function(){function a(){}return a.prototype.construct=function(a){var b=this;if(a instanceof jRexObj)return a.regex().source;if("string"==typeof a)return this.escapeRegExp(a);if("object"==typeof a&&"number"==typeof a.length)return a.map(function(a){return b.encloseForConcat(b.construct(a))}).join("");if(a instanceof RegExp)return a.source;var c=this.constructPrimary(a);return c=this.constructLoop(a,c),a.store&&(c="("+c+")"),a.close&&"end"!==a.close&&(c="^"+c),a.close&&"start"!==a.close&&(c+="$"),a.ahead&&(c="(?"+("not"==a.ahead?"!":"=")+c+")"),c},a.prototype.escapeRegExp=function(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},a.prototype.requiresEnclosing=function(a){return!(/^\\?.$/.test(a)||/^\[[^\]})]*\]$/.test(a)||/^\([^\]})]*\)$/.test(a)||/^\{[^\]})]*\}$/.test(a))},a.prototype.enclose=function(a){return this.requiresEnclosing(a)?"(?:"+a+")":a},a.prototype.encloseForConcat=function(a){return this.requiresEnclosing(a)&&a.indexOf("|")>=0?"(?:"+a+")":a},a.prototype.getPrimaryProperty=function(a){var b;return["or","text","regex","sub","any","in","out"].forEach(function(c){var d=null!=a[c];if(d){if(null!=b)throw"expected only one primary property";b=c}}),b},a.prototype.constructPrimary=function(a){var b=this,c=this.getPrimaryProperty(a),d=a[c];switch(c){case"or":return d.map(function(a){return b.enclose(b.construct(a))}).join("|");case"text":return this.construct(d.toString());case"regex":if("string"==typeof d)return d;if(d instanceof RegExp)return this.construct(d);throw"Expected a string or RegExp";case"in":return"["+d+"]";case"out":return"[^"+d+"]";case"any":if("number"==typeof d?0>=d:d!==!0)throw'expected positive number or true on "any"';return 1===d||d===!0?".":".{"+d+"}";case"sub":return this.construct(d)}},a.prototype.constructLoop=function(a,b){return(a.lazy||null!=a.min||null!=a.max||null!=a.exact)&&(b=this.enclose(b),b+=null!=a.exact?"{"+a.exact+"}":a.min||null!=a.max?a.min||1!=a.max?null==a.max?"{"+a.min+",}":a.max==a.min?"{"+a.min+"}":"{"+(a.min||0)+","+a.max+"}":"?":"*",a.lazy&&(b+="?")),b},a}();module.exports=exports=jRex;